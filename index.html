<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manajemen Keuangan - Kategori Lengkap</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background-color: #f8f9fa; }
        .card-summary { transition: transform 0.2s; }
        .card-summary:hover { transform: translateY(-5px); }
        .inc-color { color: #198754; }
        .exp-color { color: #dc3545; }
        .badge-category { font-size: 0.8em; font-weight: normal; margin-left: 5px; }
    </style>
</head>
<body>

<div class="container py-5">
    <h2 class="text-center mb-4">ðŸ’° Manajemen Keuangan Pribadi</h2>

    <div class="row mb-4 text-center">
        <div class="col-md-4">
            <div class="card card-summary shadow-sm mb-2">
                <div class="card-body">
                    <h5 class="card-title text-muted">Total Pemasukan</h5>
                    <h3 class="inc-color" id="total-income">Rp 0</h3>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card card-summary shadow-sm mb-2">
                <div class="card-body">
                    <h5 class="card-title text-muted">Total Pengeluaran</h5>
                    <h3 class="exp-color" id="total-expense">Rp 0</h3>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card card-summary shadow-sm mb-2">
                <div class="card-body">
                    <h5 class="card-title text-muted">Saldo Saat Ini</h5>
                    <h3 class="text-primary" id="balance">Rp 0</h3>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-4 mb-4">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    Tambah Transaksi Baru
                </div>
                <div class="card-body">
                    <form id="form-transaksi">
                        
                        <div class="mb-3">
                            <label class="form-label">Tanggal</label>
                            <input type="date" class="form-control" id="date" required>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Jenis Transaksi</label>
                            <select class="form-select" id="type" onchange="updateCategories()">
                                <option value="income">Pemasukan (+)</option>
                                <option value="expense">Pengeluaran (-)</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Kategori</label>
                            <select class="form-select" id="category">
                                </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Keterangan Detail</label>
                            <input type="text" class="form-control" id="text" placeholder="Contoh: Gaji Bulan Mei, Jual Kue" required>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Jumlah (Rp)</label>
                            <input type="number" class="form-control" id="amount" placeholder="0" required>
                        </div>

                        <button type="submit" class="btn btn-primary w-100">Simpan Transaksi</button>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-lg-8 mb-4">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-white">
                    Grafik Bulanan
                </div>
                <div class="card-body">
                    <canvas id="financeChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="card shadow-sm">
        <div class="card-header bg-white">
            Riwayat Transaksi
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-striped mb-0 align-middle">
                    <thead>
                        <tr>
                            <th>Tanggal</th>
                            <th>Kategori & Keterangan</th>
                            <th class="text-end">Jumlah</th>
                            <th class="text-center">Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="list">
                        </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    // --- Data Kategori ---
    const categoryOptions = {
        income: ["Gaji Utama", "Sampingan/Freelance", "Bonus/THR", "Investasi", "Hadiah", "Lainnya"],
        expense: ["Makan & Minum", "Transportasi", "Belanja Bulanan", "Tagihan (Listrik/Air)", "Hiburan", "Kesehatan", "Lainnya"]
    };

    // --- Inisialisasi DOM ---
    const balanceEl = document.getElementById('balance');
    const incomeEl = document.getElementById('total-income');
    const expenseEl = document.getElementById('total-expense');
    const listEl = document.getElementById('list');
    const form = document.getElementById('form-transaksi');
    
    const textDetails = document.getElementById('text');
    const amountDetails = document.getElementById('amount');
    const dateDetails = document.getElementById('date');
    const typeDetails = document.getElementById('type');
    const categoryDetails = document.getElementById('category');

    // Set tanggal default hari ini
    dateDetails.valueAsDate = new Date();

    // Data Transaksi dari LocalStorage
    let transactions = JSON.parse(localStorage.getItem('transactions')) || [];

    // Chart Setup
    let financeChart;
    const ctx = document.getElementById('financeChart').getContext('2d');

    // --- Fungsi Update Dropdown Kategori ---
    function updateCategories() {
        const selectedType = typeDetails.value; // 'income' atau 'expense'
        const options = categoryOptions[selectedType];
        
        categoryDetails.innerHTML = ''; // Kosongkan dulu
        
        options.forEach(opt => {
            const el = document.createElement('option');
            el.value = opt;
            el.innerText = opt;
            categoryDetails.appendChild(el);
        });
    }

    // --- Format Rupiah ---
    function formatRupiah(num) {
        return 'Rp ' + num.toFixed(0).replace(/(\d)(?=(\d{3})+(?!\d))/g, '$1.');
    }

    // --- Tambah Transaksi ---
    function addTransaction(e) {
        e.preventDefault();

        if (textDetails.value.trim() === '' || amountDetails.value.trim() === '') {
            alert('Mohon lengkapi data');
            return;
        }

        const transaction = {
            id: Date.now(), // ID unik berdasarkan waktu
            text: textDetails.value,
            category: categoryDetails.value, // Simpan kategori
            amount: +amountDetails.value,
            date: dateDetails.value,
            type: typeDetails.value
        };

        transactions.push(transaction);
        updateLocalStorage();
        init();

        // Reset form (kecuali tanggal)
        textDetails.value = '';
        amountDetails.value = '';
    }

    // --- Hapus Transaksi ---
    function removeTransaction(id) {
        if(confirm('Hapus transaksi ini?')) {
            transactions = transactions.filter(transaction => transaction.id !== id);
            updateLocalStorage();
            init();
        }
    }

    // --- Simpan ke LocalStorage ---
    function updateLocalStorage() {
        localStorage.setItem('transactions', JSON.stringify(transactions));
    }

    // --- Render List di Tabel ---
    function renderList() {
        listEl.innerHTML = '';
        const sortedTransactions = transactions.sort((a, b) => new Date(b.date) - new Date(a.date));

        sortedTransactions.forEach(trx => {
            const isIncome = trx.type === 'income';
            const sign = isIncome ? '+' : '-';
            const colorClass = isIncome ? 'text-success' : 'text-danger';
            const badgeClass = isIncome ? 'bg-success' : 'bg-danger';

            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${trx.date}</td>
                <td>
                    <span class="badge ${badgeClass} mb-1">${trx.category}</span><br>
                    <small class="text-muted">${trx.text}</small>
                </td>
                <td class="text-end ${colorClass}"><b>${sign} ${formatRupiah(trx.amount)}</b></td>
                <td class="text-center">
                    <button class="btn btn-sm btn-outline-secondary" onclick="removeTransaction(${trx.id})">&times;</button>
                </td>
            `;
            listEl.appendChild(row);
        });
    }

    // --- Hitung Total ---
    function updateValues() {
        const income = transactions
            .filter(trx => trx.type === 'income')
            .reduce((acc, trx) => acc + trx.amount, 0);

        const expense = transactions
            .filter(trx => trx.type === 'expense')
            .reduce((acc, trx) => acc + trx.amount, 0);
        
        const total = income - expense;

        balanceEl.innerText = formatRupiah(total);
        incomeEl.innerText = formatRupiah(income);
        expenseEl.innerText = formatRupiah(expense);
    }

    // --- Render Grafik ---
    function renderChart() {
        const monthlyData = {};

        transactions.forEach(trx => {
            const monthKey = trx.date.substring(0, 7); // YYYY-MM
            if (!monthlyData[monthKey]) monthlyData[monthKey] = { income: 0, expense: 0 };
            
            if (trx.type === 'income') monthlyData[monthKey].income += trx.amount;
            else monthlyData[monthKey].expense += trx.amount;
        });

        const sortedMonths = Object.keys(monthlyData).sort();
        const labels = sortedMonths;
        const dataIncome = sortedMonths.map(m => monthlyData[m].income);
        const dataExpense = sortedMonths.map(m => monthlyData[m].expense);

        if (financeChart) financeChart.destroy();

        financeChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'Pemasukan',
                        data: dataIncome,
                        backgroundColor: '#198754',
                        borderRadius: 4
                    },
                    {
                        label: 'Pengeluaran',
                        data: dataExpense,
                        backgroundColor: '#dc3545',
                        borderRadius: 4
                    }
                ]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { position: 'top' },
                },
                scales: {
                    y: { beginAtZero: true }
                }
            }
        });
    }

    // --- Start ---
    typeDetails.addEventListener('change', updateCategories);
    form.addEventListener('submit', addTransaction);
    
    // Inisialisasi awal
    updateCategories(); // Set opsi kategori default
    init();

    function init() {
        renderList();
        updateValues();
        renderChart();
    }
</script>

</body>
</html>