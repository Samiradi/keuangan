<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manajemen Keuangan Multi-User</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background-color: #f8f9fa; }
        .card-summary { transition: transform 0.2s; }
        .card-summary:hover { transform: translateY(-5px); }
        .inc-color { color: #198754; }
        .exp-color { color: #dc3545; }
        
        /* Styles untuk Login Screen */
        #login-screen {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: #e9ecef;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        #app-screen { display: none; } /* Sembunyikan aplikasi sebelum login */
    </style>
</head>
<body>

<div id="login-screen">
    <div class="card shadow p-4" style="width: 350px;">
        <h3 class="text-center mb-3">üîê Login</h3>
        <p class="text-center text-muted small">Masukkan nama Anda untuk mengakses data keuangan pribadi Anda.</p>
        <form id="form-login">
            <div class="mb-3">
                <label class="form-label">Nama Pengguna</label>
                <input type="text" id="username-input" class="form-control" placeholder="Contoh: Budi" required>
            </div>
            <button type="submit" class="btn btn-primary w-100">Masuk / Buat Akun</button>
        </form>
    </div>
</div>

<div id="app-screen" class="container py-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>üí∞ Keuangan: <span id="user-display" class="text-primary"></span></h2>
        <button onclick="logout()" class="btn btn-outline-danger btn-sm">Keluar</button>
    </div>

    <div class="row mb-4 text-center">
        <div class="col-md-4">
            <div class="card card-summary shadow-sm mb-2">
                <div class="card-body">
                    <h5 class="card-title text-muted">Total Pemasukan</h5>
                    <h3 class="inc-color" id="total-income">Rp 0</h3>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card card-summary shadow-sm mb-2">
                <div class="card-body">
                    <h5 class="card-title text-muted">Total Pengeluaran</h5>
                    <h3 class="exp-color" id="total-expense">Rp 0</h3>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card card-summary shadow-sm mb-2">
                <div class="card-body">
                    <h5 class="card-title text-muted">Saldo Saat Ini</h5>
                    <h3 class="text-primary" id="balance">Rp 0</h3>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-4 mb-4">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    Tambah Transaksi
                </div>
                <div class="card-body">
                    <form id="form-transaksi">
                        <div class="mb-3">
                            <label class="form-label">Tanggal</label>
                            <input type="date" class="form-control" id="date" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Jenis</label>
                            <select class="form-select" id="type" onchange="updateCategories()">
                                <option value="income">Pemasukan (+)</option>
                                <option value="expense">Pengeluaran (-)</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Kategori</label>
                            <select class="form-select" id="category"></select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Keterangan</label>
                            <input type="text" class="form-control" id="text" placeholder="Detail..." required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Jumlah (Rp)</label>
                            <input type="number" class="form-control" id="amount" placeholder="0" required>
                        </div>
                        <button type="submit" class="btn btn-primary w-100">Simpan</button>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-lg-8 mb-4">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-white">
                    Grafik Bulanan
                </div>
                <div class="card-body">
                    <canvas id="financeChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="card shadow-sm">
        <div class="card-header bg-white">Riwayat Transaksi</div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-striped mb-0 align-middle">
                    <thead>
                        <tr>
                            <th>Tanggal</th>
                            <th>Keterangan</th>
                            <th class="text-end">Jumlah</th>
                            <th class="text-center">Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="list"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    // --- VARIABEL GLOBAL ---
    let currentUser = null;
    let transactions = [];
    let financeChart;

    // --- DOM Elements ---
    const loginScreen = document.getElementById('login-screen');
    const appScreen = document.getElementById('app-screen');
    const userDisplay = document.getElementById('user-display');
    const formLogin = document.getElementById('form-login');
    const usernameInput = document.getElementById('username-input');

    // --- Kategori Data ---
    const categoryOptions = {
        income: ["Gaji Utama", "Sampingan", "Bonus", "Investasi", "Lainnya"],
        expense: ["Makan", "Transport", "Belanja", "Tagihan", "Hiburan", "Lainnya"]
    };

    // --- SISTEM LOGIN ---
    formLogin.addEventListener('submit', function(e) {
        e.preventDefault();
        const username = usernameInput.value.trim();
        if(username) {
            currentUser = username; // Set user aktif
            userDisplay.innerText = currentUser;
            
            // Sembunyikan login, munculkan app
            loginScreen.style.display = 'none';
            appScreen.style.display = 'block';
            
            // Load data khusus user ini
            loadUserData();
        }
    });

    function logout() {
        currentUser = null;
        transactions = [];
        loginScreen.style.display = 'flex';
        appScreen.style.display = 'none';
        usernameInput.value = '';
    }

    // --- MANAJEMEN DATA ---
    function loadUserData() {
        // KUNCI UTAMA: Kita membedakan nama penyimpanan berdasarkan user
        // Contoh: 'transactions_Budi' atau 'transactions_Siti'
        const storageKey = 'transactions_' + currentUser.toLowerCase(); 
        transactions = JSON.parse(localStorage.getItem(storageKey)) || [];
        
        initApp(); // Jalankan aplikasi setelah data dimuat
    }

    function updateLocalStorage() {
        if (!currentUser) return;
        const storageKey = 'transactions_' + currentUser.toLowerCase();
        localStorage.setItem(storageKey, JSON.stringify(transactions));
    }

    // --- LOGIKA APLIKASI KEUANGAN ---
    const listEl = document.getElementById('list');
    const balanceEl = document.getElementById('balance');
    const incomeEl = document.getElementById('total-income');
    const expenseEl = document.getElementById('total-expense');
    const form = document.getElementById('form-transaksi');
    const ctx = document.getElementById('financeChart').getContext('2d');
    
    // Form Inputs
    const textDetails = document.getElementById('text');
    const amountDetails = document.getElementById('amount');
    const dateDetails = document.getElementById('date');
    const typeDetails = document.getElementById('type');
    const categoryDetails = document.getElementById('category');

    dateDetails.valueAsDate = new Date();

    function updateCategories() {
        const options = categoryOptions[typeDetails.value];
        categoryDetails.innerHTML = '';
        options.forEach(opt => {
            const el = document.createElement('option');
            el.value = opt; el.innerText = opt;
            categoryDetails.appendChild(el);
        });
    }

    function formatRupiah(num) {
        return 'Rp ' + num.toFixed(0).replace(/(\d)(?=(\d{3})+(?!\d))/g, '$1.');
    }

    function addTransaction(e) {
        e.preventDefault();
        if (textDetails.value.trim() === '' || amountDetails.value.trim() === '') return;

        const transaction = {
            id: Date.now(),
            text: textDetails.value,
            category: categoryDetails.value,
            amount: +amountDetails.value,
            date: dateDetails.value,
            type: typeDetails.value
        };

        transactions.push(transaction);
        updateLocalStorage();
        initApp();
        textDetails.value = ''; amountDetails.value = '';
    }

    function removeTransaction(id) {
        if(confirm('Hapus data ini?')) {
            transactions = transactions.filter(t => t.id !== id);
            updateLocalStorage();
            initApp();
        }
    }

    function renderList() {
        listEl.innerHTML = '';
        transactions.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(trx => {
            const isInc = trx.type === 'income';
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${trx.date}</td>
                <td><span class="badge ${isInc ? 'bg-success' : 'bg-danger'}">${trx.category}</span> <br><small>${trx.text}</small></td>
                <td class="text-end ${isInc ? 'text-success' : 'text-danger'}">${isInc ? '+' : '-'} ${formatRupiah(trx.amount)}</td>
                <td class="text-center"><button class="btn btn-sm btn-outline-secondary" onclick="removeTransaction(${trx.id})">&times;</button></td>
            `;
            listEl.appendChild(row);
        });
    }

    function updateValues() {
        const inc = transactions.filter(t => t.type === 'income').reduce((acc, t) => acc + t.amount, 0);
        const exp = transactions.filter(t => t.type === 'expense').reduce((acc, t) => acc + t.amount, 0);
        balanceEl.innerText = formatRupiah(inc - exp);
        incomeEl.innerText = formatRupiah(inc);
        expenseEl.innerText = formatRupiah(exp);
    }

    function renderChart() {
        const monthlyData = {};
        transactions.forEach(trx => {
            const k = trx.date.substring(0, 7);
            if (!monthlyData[k]) monthlyData[k] = { inc: 0, exp: 0 };
            trx.type === 'income' ? monthlyData[k].inc += trx.amount : monthlyData[k].exp += trx.amount;
        });

        const labels = Object.keys(monthlyData).sort();
        if (financeChart) financeChart.destroy();

        financeChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    { label: 'Masuk', data: labels.map(m => monthlyData[m].inc), backgroundColor: '#198754' },
                    { label: 'Keluar', data: labels.map(m => monthlyData[m].exp), backgroundColor: '#dc3545' }
                ]
            },
            options: { responsive: true, scales: { y: { beginAtZero: true } } }
        });
    }

    function initApp() {
        renderList();
        updateValues();
        renderChart();
    }

    // Start
    typeDetails.addEventListener('change', updateCategories);
    form.addEventListener('submit', addTransaction);
    updateCategories();
</script>

</body>
</html>